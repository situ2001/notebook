<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Design patterns | Situ Book</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo-book.svg">
    <link rel="stylesheet" href="/katex.min.css">
    <meta name="description" content="Taking notes">
    
    <link rel="preload" href="/assets/css/0.styles.7f9e08b5.css" as="style"><link rel="preload" href="/assets/js/app.ea6663fd.js" as="script"><link rel="preload" href="/assets/js/2.2ade0f41.js" as="script"><link rel="preload" href="/assets/js/7.a1840e06.js" as="script"><link rel="prefetch" href="/assets/js/10.f233493b.js"><link rel="prefetch" href="/assets/js/11.3f081569.js"><link rel="prefetch" href="/assets/js/12.a934fec2.js"><link rel="prefetch" href="/assets/js/13.d10f4f24.js"><link rel="prefetch" href="/assets/js/14.3c7e1479.js"><link rel="prefetch" href="/assets/js/15.e52f0048.js"><link rel="prefetch" href="/assets/js/16.113eb911.js"><link rel="prefetch" href="/assets/js/17.341fa188.js"><link rel="prefetch" href="/assets/js/18.b936b6a2.js"><link rel="prefetch" href="/assets/js/19.b9aed1f5.js"><link rel="prefetch" href="/assets/js/20.12f3b9c3.js"><link rel="prefetch" href="/assets/js/21.58c30670.js"><link rel="prefetch" href="/assets/js/22.354d558f.js"><link rel="prefetch" href="/assets/js/23.861c68ca.js"><link rel="prefetch" href="/assets/js/24.bc200e6d.js"><link rel="prefetch" href="/assets/js/25.1e9fe201.js"><link rel="prefetch" href="/assets/js/26.54e59082.js"><link rel="prefetch" href="/assets/js/27.f4ad160b.js"><link rel="prefetch" href="/assets/js/28.29ee3e98.js"><link rel="prefetch" href="/assets/js/29.bd6ee8b5.js"><link rel="prefetch" href="/assets/js/3.ec92e282.js"><link rel="prefetch" href="/assets/js/30.541f8167.js"><link rel="prefetch" href="/assets/js/31.037c3dc9.js"><link rel="prefetch" href="/assets/js/32.c0b955b2.js"><link rel="prefetch" href="/assets/js/33.979c85e9.js"><link rel="prefetch" href="/assets/js/34.d71a2d26.js"><link rel="prefetch" href="/assets/js/35.8db144e8.js"><link rel="prefetch" href="/assets/js/36.9f42b17c.js"><link rel="prefetch" href="/assets/js/37.d0ac2360.js"><link rel="prefetch" href="/assets/js/38.5e149ae7.js"><link rel="prefetch" href="/assets/js/39.e5f70a0f.js"><link rel="prefetch" href="/assets/js/4.f5690707.js"><link rel="prefetch" href="/assets/js/40.82590afe.js"><link rel="prefetch" href="/assets/js/41.d20b2d2a.js"><link rel="prefetch" href="/assets/js/42.72325b83.js"><link rel="prefetch" href="/assets/js/43.bf9e8524.js"><link rel="prefetch" href="/assets/js/44.7f8c150c.js"><link rel="prefetch" href="/assets/js/45.225d982c.js"><link rel="prefetch" href="/assets/js/46.1a4774f2.js"><link rel="prefetch" href="/assets/js/47.c0f2e358.js"><link rel="prefetch" href="/assets/js/48.ea0244d1.js"><link rel="prefetch" href="/assets/js/49.ef097b3d.js"><link rel="prefetch" href="/assets/js/5.19bca545.js"><link rel="prefetch" href="/assets/js/50.f82252cc.js"><link rel="prefetch" href="/assets/js/51.d1f682e9.js"><link rel="prefetch" href="/assets/js/52.30a40989.js"><link rel="prefetch" href="/assets/js/53.3f16a7b4.js"><link rel="prefetch" href="/assets/js/54.032b596d.js"><link rel="prefetch" href="/assets/js/55.47b9e5f8.js"><link rel="prefetch" href="/assets/js/56.b538550e.js"><link rel="prefetch" href="/assets/js/57.e21338dc.js"><link rel="prefetch" href="/assets/js/58.f95c603e.js"><link rel="prefetch" href="/assets/js/59.81e49b42.js"><link rel="prefetch" href="/assets/js/6.c9f59a92.js"><link rel="prefetch" href="/assets/js/8.3a9b8360.js"><link rel="prefetch" href="/assets/js/9.23617160.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7f9e08b5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Situ Book</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://blog.situ2001.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/situ2001" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://blog.situ2001.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/situ2001" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tools</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/basis.html" class="sidebar-link">Basis</a></li><li><a href="/java/problems.html" class="sidebar-link">Problems</a></li><li><a href="/java/feature_jdk.html" class="sidebar-link">Feature</a></li><li><a href="/java/multithreading.html" class="sidebar-link">MultiThreading</a></li><li><a href="/java/design_patterns.html" aria-current="page" class="active sidebar-link">Design patterns</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/design_patterns.html#observer-pattern-javafx" class="sidebar-link">Observer Pattern(JavaFX)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/design_patterns.html#写在前面" class="sidebar-link">写在前面</a></li><li class="sidebar-sub-header"><a href="/java/design_patterns.html#上手之前" class="sidebar-link">上手之前</a></li><li class="sidebar-sub-header"><a href="/java/design_patterns.html#开始胡乱分析" class="sidebar-link">开始胡乱分析</a></li><li class="sidebar-sub-header"><a href="/java/design_patterns.html#亲手试错" class="sidebar-link">亲手试错</a></li><li class="sidebar-sub-header"><a href="/java/design_patterns.html#最后总结" class="sidebar-link">最后总结</a></li></ul></li></ul></li><li><a href="/java/reflection.html" class="sidebar-link">Reflection</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>C/C++</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构与算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node.js</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>课程</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="design-patterns"><a href="#design-patterns" class="header-anchor">#</a> Design patterns</h1> <p>此页面有待重改</p> <h2 id="observer-pattern-javafx"><a href="#observer-pattern-javafx" class="header-anchor">#</a> Observer Pattern(JavaFX)</h2> <p>本文中的JavaFX版本号为<code>11.0.9</code></p> <h3 id="写在前面"><a href="#写在前面" class="header-anchor">#</a> 写在前面</h3> <p>最近的军训真的又干燥又冷，我感到十分不舒服。不过军训的中午，拥有长达两个钟的吃饭与休息时间。闲来无事，我就捡起了好两个星期没有接触的Java（这两个星期游戏+复习+发烧，时间都没耗光了）</p> <p>那么言归正传，之前我学了并会在一些简单的实际应用中使用Java的OOP，并了解到了一些设计模式。最近又想了解一下Observer Pattern（观察者模式），那么我能否通过阅读我所熟练使用的JavaFX源码来了解这个设计模式呢？</p> <h3 id="上手之前"><a href="#上手之前" class="header-anchor">#</a> 上手之前</h3> <p>“知己知彼，百战百胜。”这句话还是一样重要，所以我先去找了下观察者模式的解释。</p> <blockquote><p>定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都得到通知并被自动更新。</p></blockquote> <p>通俗地讲，就是对象在更新的时候，顺便通知其他对象，从而使得其他对象得到更新？</p> <p>我写了一段使用JavaFX代码，运行后，窗口中的宽度与高度大小信息都会随着窗体的大小变化而更新。如下</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">javafx<span class="token punctuation">.</span>application<span class="token punctuation">.</span></span><span class="token class-name">Application</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javafx<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">InvalidationListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javafx<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">Observable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javafx<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>property<span class="token punctuation">.</span></span><span class="token class-name">ReadOnlyDoubleProperty</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span></span><span class="token class-name">Pos</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span></span><span class="token class-name">Scene</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>layout<span class="token punctuation">.</span></span><span class="token class-name">VBox</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">Text</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javafx<span class="token punctuation">.</span>stage<span class="token punctuation">.</span></span><span class="token class-name">Stage</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavaFXBinding</span> <span class="token keyword">extends</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token class-name">Stage</span> primaryStage<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">VBox</span> pane <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VBox</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Text</span> textWidth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Text</span> textHeight <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pane<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>textHeight<span class="token punctuation">,</span> textWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pane<span class="token punctuation">.</span><span class="token function">setAlignment</span><span class="token punctuation">(</span><span class="token class-name">Pos</span><span class="token punctuation">.</span>CENTER<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//set invalidation listener</span>
        primaryStage<span class="token punctuation">.</span><span class="token function">widthProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InvalidationListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invalidated</span><span class="token punctuation">(</span><span class="token class-name">Observable</span> observable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> width <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Width: %.2f&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ReadOnlyDoubleProperty</span><span class="token punctuation">)</span>observable<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                textHeight<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        primaryStage<span class="token punctuation">.</span><span class="token function">heightProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InvalidationListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invalidated</span><span class="token punctuation">(</span><span class="token class-name">Observable</span> observable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> height <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Height: %.2f&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ReadOnlyDoubleProperty</span><span class="token punctuation">)</span>observable<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                textWidth<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Scene</span> scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span>pane<span class="token punctuation">)</span><span class="token punctuation">;</span>
        primaryStage<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">&quot;TEST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        primaryStage<span class="token punctuation">.</span><span class="token function">setScene</span><span class="token punctuation">(</span>scene<span class="token punctuation">)</span><span class="token punctuation">;</span>
        primaryStage<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>并且有使用IDEA IDE</p> <h3 id="开始胡乱分析"><a href="#开始胡乱分析" class="header-anchor">#</a> 开始胡乱分析</h3> <p>可以看出，窗口里头<code>Text</code>的字符串变换是通过这一段代码实现的。这里以Width（窗体宽度）来说。</p> <div class="language-java extra-class"><pre class="language-java"><code>primaryStage<span class="token punctuation">.</span><span class="token function">widthProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InvalidationListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invalidated</span><span class="token punctuation">(</span><span class="token class-name">Observable</span> observable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> width <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Width: %.2f&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ReadOnlyDoubleProperty</span><span class="token punctuation">)</span>observable<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        textHeight<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>从这段代码来看，应该是通过invoke <code>widthProperty()</code>来获取<code>primaryStage</code>这个对象里头的<code>ReadOnlyDoubleProperty</code>宽度width，然后对其invoke <code>addListener(javafx.beans.InvalidationListener listener)</code>方法来添加listener。</p> <p>那我们先跳转到<code>primaryStage</code>这个对象的<code>widthProperty()</code>方法所在位置。</p> <p>我们在<code>javafx.stage.Windows</code>类下发现了这个，并根据上下文，再复制了其他的片段，如下所示。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ReadOnlyDoubleWrapper</span> width <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadOnlyDoubleWrapper</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;width&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Double<span class="token punctuation">.</span>NaN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ReadOnlyDoubleProperty</span> <span class="token function">widthProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> width<span class="token punctuation">.</span><span class="token function">getReadOnlyProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>这里出现了不同的两个类型，并且里面涉及到的方法又去到了其他的类，查了一下jfx的文档，发现了类之间的继承关系如下。</p> <div class="language-text extra-class"><pre class="language-text"><code>Class ReadOnlyDoubleWrapper
java.lang.Object
javafx.beans.binding.NumberExpressionBase
javafx.beans.binding.DoubleExpression
javafx.beans.property.ReadOnlyDoubleProperty
javafx.beans.property.DoubleProperty
javafx.beans.property.DoublePropertyBase
javafx.beans.property.SimpleDoubleProperty
javafx.beans.property.ReadOnlyDoubleWrapper

All Implemented Interfaces:
NumberExpression, Observable, Property&lt;Number&gt;, ReadOnlyProperty&lt;Number&gt;, ObservableDoubleValue, ObservableNumberValue, ObservableValue&lt;Number&gt;, WritableDoubleValue, WritableNumberValue, WritableValue&lt;Number&gt;

public abstract class ReadOnlyDoubleProperty extends DoubleExpression implements ReadOnlyProperty&lt;Number&gt;
public class ReadOnlyDoubleWrapper extends SimpleDoubleProperty
</code></pre></div><p><img src="/assets/img/ReadOnlyDoubleWrapper.1f1e95b1.png" alt="ReadOnlyDoubleWrapper"></p> <p>由上可见，<code>ReadOnlyDoubleProperty</code>是一个抽象类，而<code>ReadOnlyDoubleWrapper</code>是一个concrete的实实在在的类。通过下面的分析可以查出，一个<code>ReadOnlyDoubleWrapper</code>是如何被construct的。</p> <p>我们首先在<code>ReadOnlyDoubleWrapper</code>的constructor里头发现了<code>with-arg</code>的<code>super()</code>，也就是说它显示地invoke了父类的constructor。父类里的constructor也是如此的操作，直到来到了类<code>DoublePropertyBase</code>才停了下来。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//class ReadOnlyDoubleWrapper</span>
<span class="token keyword">public</span> <span class="token class-name">ReadOnlyDoubleWrapper</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span>
        <span class="token keyword">double</span> initialValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> name<span class="token punctuation">,</span> initialValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//class SimpleDoubleProperty</span>
<span class="token keyword">public</span> <span class="token class-name">SimpleDoubleProperty</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">double</span> initialValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>initialValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bean <span class="token operator">=</span> bean<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> DEFAULT_NAME <span class="token operator">:</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//class DoublePropertyBase</span>
<span class="token keyword">public</span> <span class="token class-name">DoublePropertyBase</span><span class="token punctuation">(</span><span class="token keyword">double</span> initialValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> initialValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么，最后返回的是个什么对象？仔细地查看了一下如下的代码，发现这是通过一个私有类<code>ReadOnlyPropertyImpl</code>将一个可写的property转化为了一个只读的property</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ReadOnlyPropertyImpl</span> readOnlyProperty<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">ReadOnlyDoubleProperty</span> <span class="token function">getReadOnlyProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>readOnlyProperty <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        readOnlyProperty <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadOnlyPropertyImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> readOnlyProperty<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ReadOnlyPropertyImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ReadOnlyDoublePropertyBase</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ReadOnlyDoubleWrapper</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ReadOnlyDoubleWrapper</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ReadOnlyDoubleWrapper</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这个私有类的继承关系如下，为了更好看，我去IDEA上生成了关系图</p> <div class="language-text extra-class"><pre class="language-text"><code>Class ReadOnlyDoublePropertyBase
java.lang.Object
javafx.beans.binding.NumberExpressionBase
javafx.beans.binding.DoubleExpression
javafx.beans.property.ReadOnlyDoubleProperty
javafx.beans.property.ReadOnlyDoublePropertyBase
javafx.beans.property.ReadOnlyDoubleWrapper.ReadOnlyPropertyImpl

All Implemented Interfaces:
NumberExpression, Observable, ReadOnlyProperty&lt;Number&gt;, ObservableDoubleValue, ObservableNumberValue, ObservableValue&lt;Number&gt;
</code></pre></div><p><img src="/assets/img/ReadOnlyPropertyImpl.bf9f9c23.png" alt="ReadOnlyPropertyImpl"></p> <p>啊，因为在Stage里头的width需要更改，所以要是个可读可写的property。但可以用一个内部私有类，把一个property肛成一个read-only property。并根据dynamic binding将<code>ObservableDoubleValue</code>和<code>ReadOnlyProperty</code>里头的方法给实现掉（原先是在类<code>DoublePropertyBase</code>和<code>SimpleDoubleProperty</code>里头实现的）。实在是妙！</p> <p>并且查阅文档可以发现内部私有类<code>ReadOnlyPropertyImpl</code>与Listener有关的方法，全部在<code>ReadOnlyDoublePropertyBase</code>类里头。</p> <p>所以我们要看<code>addListener</code>的实现，就要去<code>DoublePropertyBase</code>这个类里头看了。如下所示</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ExpressionHelper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Number</span><span class="token punctuation">&gt;</span></span> helper<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">InvalidationListener</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    helper <span class="token operator">=</span> <span class="token class-name">ExpressionHelper</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>helper<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>az，里面竟然还有一个<code>ExpressionHelper</code>？？？不管是马是驴，先溜出来看看。看起来这个<code>ExpressionHelper</code>是个抽象类，提供了许多abstract方法，然后由这个抽象类里头concrete的私有内部类实现。调用这个类里面的东西，经过阅读，其实几乎都是从static方法里头把value pass进去处理的。</p> <p>选择性地抽出<code>ExpressionHelper</code>的部分代码。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">ObservableValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> observable<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">ExpressionHelper</span><span class="token punctuation">(</span><span class="token class-name">ObservableValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> observable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>observable <span class="token operator">=</span> observable<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ExpressionHelper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">ExpressionHelper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> helper<span class="token punctuation">,</span> <span class="token class-name">ObservableValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> observable<span class="token punctuation">,</span> <span class="token class-name">InvalidationListener</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>observable <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>listener <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    observable<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// validate observable</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>helper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">SingleInvalidation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>observable<span class="token punctuation">,</span> listener<span class="token punctuation">)</span> <span class="token operator">:</span> helper<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//part of the code</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SingleInvalidation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ExpressionHelper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">InvalidationListener</span> listener<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">SingleInvalidation</span><span class="token punctuation">(</span><span class="token class-name">ObservableValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> expression<span class="token punctuation">,</span> <span class="token class-name">InvalidationListener</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>listener <span class="token operator">=</span> listener<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">ExpressionHelper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">InvalidationListener</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Generic</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>observable<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listener<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//part of the code</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Generic</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ExpressionHelper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">InvalidationListener</span><span class="token punctuation">[</span><span class="token punctuation">]</span> invalidationListeners<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ChangeListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> changeListeners<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> invalidationSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> changeSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> locked<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> currentValue<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Generic</span><span class="token punctuation">(</span><span class="token class-name">ObservableValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> observable<span class="token punctuation">,</span> <span class="token class-name">InvalidationListener</span> listener0<span class="token punctuation">,</span> <span class="token class-name">InvalidationListener</span> listener1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>observable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>invalidationListeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvalidationListener</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>listener0<span class="token punctuation">,</span> listener1<span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>invalidationSize <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Generic</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">InvalidationListener</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>invalidationListeners <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            invalidationListeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvalidationListener</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>listener<span class="token punctuation">}</span><span class="token punctuation">;</span>
            invalidationSize <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> oldCapacity <span class="token operator">=</span> invalidationListeners<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>locked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> newCapacity <span class="token operator">=</span> <span class="token punctuation">(</span>invalidationSize <span class="token operator">&lt;</span> oldCapacity<span class="token punctuation">)</span><span class="token operator">?</span> oldCapacity <span class="token operator">:</span> <span class="token punctuation">(</span>oldCapacity <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                invalidationListeners <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>invalidationListeners<span class="token punctuation">,</span> newCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>invalidationSize <span class="token operator">==</span> oldCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                invalidationSize <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span>invalidationSize<span class="token punctuation">,</span> invalidationListeners<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>invalidationSize <span class="token operator">==</span> oldCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span> newCapacity <span class="token operator">=</span> <span class="token punctuation">(</span>oldCapacity <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    invalidationListeners <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>invalidationListeners<span class="token punctuation">,</span> newCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            invalidationListeners<span class="token punctuation">[</span>invalidationSize<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> listener<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>根据<strong>SingleInvalidation</strong>的英语意思，可以猜测这个类是专门处理只有一个listener的情况的，再结合<code>Generic</code>的constructor的代码和<code>SingleInvalidation</code>中<code>addListener()</code>，在new这个对象的时候顺便也把Observable通过<code>super(expression);</code>给赋值进去了。并可以猜测，当有超过一个listener嗷嗷待哺的时候，<code>ExpressionHelper</code>中的static方法就会return一个<code>Generic</code>对象给<code>DoublePropertyBase</code>中的helper对象。也就是说，所有的listener都被保存在了property对象的helper对象里头。</p> <p>那么，言归正传，到底property的value变化是怎么样让listener们知道的呢？</p> <p>那么，在这个例子里头，width property的更改，是随着窗体大小的更改而更改的。那么我猜测可以通过看<code>javafx.stage.Windows</code>里头的方法来找到根源。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setWidth</span><span class="token punctuation">(</span><span class="token keyword">double</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    width<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    peerBoundsConfigurator<span class="token punctuation">.</span><span class="token function">setWindowWidth</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    widthExplicit <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看出，这个width是通过<code>set(double value)</code>方法更改值的。通过IDE强大的定位功能，我一番小操作，就来到了<code>DoublePropertyBase</code>里头，找到了这么点代码</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">double</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span>
                <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; : &quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;A bound value cannot be set.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
        <span class="token function">markInvalid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">markInvalid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>valid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token function">invalidated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fireValueChangedEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但是，我们做出监听的对象是<code>ReadOnlyDoubleWrapper</code>啊，那么怎么就只定位到了<code>DoublePropertyBase</code>呢？大脑告诉我，IDE不是万能的，只是我自己太菜导致万万不能而已。回想刚刚上面记录的继承关系图和<code>width</code>的实际类型，我顺藤摸瓜，来到了<code>ReadOnlyDoubleWrapper</code>，果不其然，找到了Override的方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ReadOnlyPropertyImpl</span> readOnlyProperty<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">fireValueChangedEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">fireValueChangedEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>readOnlyProperty <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        readOnlyProperty<span class="token punctuation">.</span><span class="token function">fireValueChangedEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>又根据<code>ReadOnlyDoubleWrapper</code>的继承关系图，我找到了。<code>ReadOnlyDoublePropertyBase</code>里头的这个方法的确是被调用了。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">fireValueChangedEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ExpressionHelper</span><span class="token punctuation">.</span><span class="token function">fireValueChangedEvent</span><span class="token punctuation">(</span>helper<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>来到这里，就已经稳得一笔了，我们只需要定位到<code>ReadOnlyDoublePropertyBase</code>里头的helper实际所属的类，找到<code>fireValueChangedEvent()</code>方法即可</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//ExpressionHelper (Part)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">fireValueChangedEvent</span><span class="token punctuation">(</span><span class="token class-name">ExpressionHelper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> helper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>helper <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        helper<span class="token punctuation">.</span><span class="token function">fireValueChangedEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//SingleInvalidator (Part)</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">ObservableValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> observable<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">fireValueChangedEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        listener<span class="token punctuation">.</span><span class="token function">invalidated</span><span class="token punctuation">(</span>observable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uncaughtException</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//Generic (Part)</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Generic</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ExpressionHelper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">InvalidationListener</span><span class="token punctuation">[</span><span class="token punctuation">]</span> invalidationListeners<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ChangeListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> changeListeners<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> invalidationSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> changeSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> locked<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> currentValue<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">fireValueChangedEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">InvalidationListener</span><span class="token punctuation">[</span><span class="token punctuation">]</span> curInvalidationList <span class="token operator">=</span> invalidationListeners<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> curInvalidationSize <span class="token operator">=</span> invalidationSize<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ChangeListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> curChangeList <span class="token operator">=</span> changeListeners<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> curChangeSize <span class="token operator">=</span> changeSize<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            locked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> curInvalidationSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    curInvalidationList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">invalidated</span><span class="token punctuation">(</span>observable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uncaughtException</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>curChangeSize <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">T</span> oldValue <span class="token operator">=</span> currentValue<span class="token punctuation">;</span>
                currentValue <span class="token operator">=</span> observable<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> changed <span class="token operator">=</span> <span class="token punctuation">(</span>currentValue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token punctuation">(</span>oldValue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token operator">!</span>currentValue<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>changed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> curChangeSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            curChangeList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">changed</span><span class="token punctuation">(</span>observable<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> currentValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uncaughtException</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            locked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从<code>SingleInvalidation</code>中的<code>fireValueChangedEvent()</code>中可以看出，直接对已经实现了的<code>InvalidationListener</code>进行方法invoke，如果是一个以上的话，就是for循环分别调用不同<code>InvalidationListener</code>的<code>invalidated()</code>方法，其中还有一些其他的判断，跟这里暂时没啥关系，先不提。</p> <p>那么，做出了推理之后，是不是要Debug验证一下呢？于是我在IDE中，给这里下了个Breakpoint</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//ReadOnlyDoublePropertyBase</span>
<span class="token class-name">ExpressionHelper</span><span class="token punctuation">.</span><span class="token function">fireValueChangedEvent</span><span class="token punctuation">(</span>helper<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//breakpoint here</span>
</code></pre></div><p>从Frame来看，我的思路被验证了，是正确的</p> <p><img src="/assets/img/Screenshot202101-13131134.97d6aa60.jpg" alt="Debug"></p> <h3 id="亲手试错"><a href="#亲手试错" class="header-anchor">#</a> 亲手试错</h3> <p>竟然不明不白地就这样分析了一通InvalidationListener的实现，对Observer Pattern也有了更进一步的了解。于是垃圾地模拟了一下好像现实的场景：有一个商店里面有商品要抢购，而顾客们迫切地想知道商品的补货信息。但是，你是一个Customer，而不一定是一个Subscriber。</p> <p>思路就是，实现一个Subscription接口，然后由Customer实现，最后Store里头存储着subscribers，并会提醒subscriber们关于价格和库存的更新。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">test</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Store</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Customer</span> customer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Customer</span><span class="token punctuation">(</span><span class="token string">&quot;Situ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Customer</span> customer1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Customer</span><span class="token punctuation">(</span><span class="token string">&quot;Tony&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        customer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">;</span>
        customer1<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">;</span>

        store<span class="token punctuation">.</span><span class="token function">updatePrice</span><span class="token punctuation">(</span><span class="token number">1919810</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        store<span class="token punctuation">.</span><span class="token function">updateStock</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        customer1<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">;</span>
        store<span class="token punctuation">.</span><span class="token function">updateStock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        customer<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Store</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Subscription</span><span class="token punctuation">&gt;</span></span> subscribers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Product</span> product <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">addSubscriber</span><span class="token punctuation">(</span><span class="token class-name">Subscription</span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;A subscriber subscribes the product!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subscribers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">removeSubscriber</span><span class="token punctuation">(</span><span class="token class-name">Subscription</span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;A subscriber unsubscribes the product!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subscribers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">updateStock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        product<span class="token punctuation">.</span><span class="token function">setStock</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        subscribers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>subscription <span class="token operator">-&gt;</span> subscription<span class="token punctuation">.</span><span class="token function">notifyStock</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">updatePrice</span><span class="token punctuation">(</span><span class="token keyword">int</span> price<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        product<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
        subscribers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>subscription <span class="token operator">-&gt;</span> subscription<span class="token punctuation">.</span><span class="token function">notifyPriceChange</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> price<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> stock<span class="token punctuation">;</span>

    <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        price <span class="token operator">=</span> <span class="token number">114514</span><span class="token punctuation">;</span>
        stock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> price<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token keyword">int</span> price<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>price <span class="token operator">=</span> price<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setStock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stock <span class="token operator">=</span> status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stock<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">Subscription</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">notifyStock</span><span class="token punctuation">(</span><span class="token class-name">Product</span> product<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">notifyPriceChange</span><span class="token punctuation">(</span><span class="token class-name">Product</span> product<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token keyword">implements</span> <span class="token class-name">Subscription</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token class-name">Customer</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyStock</span><span class="token punctuation">(</span><span class="token class-name">Product</span> product<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hi, &quot;</span> <span class="token operator">+</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;. The product is &quot;</span>
                <span class="token operator">+</span> <span class="token punctuation">(</span>product<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;in stock&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;out of stock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyPriceChange</span><span class="token punctuation">(</span><span class="token class-name">Product</span> product<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hi, &quot;</span> <span class="token operator">+</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token string">&quot;. The price of product is changed. New price is $&quot;</span> <span class="token operator">+</span> product<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Store</span> store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        store<span class="token punctuation">.</span><span class="token function">addSubscriber</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token class-name">Store</span> store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        store<span class="token punctuation">.</span><span class="token function">removeSubscriber</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行结果为</p> <div class="language-text extra-class"><pre class="language-text"><code>A subscriber subscribes the product!
A subscriber subscribes the product!
Hi, Situ. The price of product is changed. New price is $1919810
Hi, Tony. The price of product is changed. New price is $1919810
Hi, Situ. The product is out of stock
Hi, Tony. The product is out of stock
A subscriber unsubscribes the product!
Hi, Situ. The product is in stock
A subscriber unsubscribes the product!
</code></pre></div><h3 id="最后总结"><a href="#最后总结" class="header-anchor">#</a> 最后总结</h3> <p><s>(套话)观察者模式是一种前人总结的有用的编程经验，适用于各种中大型OOP项目中。</s></p> <p>总的来说，我就感受到了，这种pattern有些许优点：</p> <ol><li>在运行时可以即刻建立俩对象之间的关系</li> <li>遵循开闭原则，subscriber和publisher的代码单独修改时候互不影响</li></ol> <p>缺点嘛。。。我还太弱了，找不出多少优缺点，不过我感觉这些subscriber在被通知的时候是直接按某种顺序的？也就是说不能通知指定一个subscriber？</p> <p>最后，阅读这么一小撮源码，也发现到了一些操作我在书上没见过的，看来这就是“纸上得来终觉浅”？</p> <p>如果有什么不妥的，请大佬在评论区指出。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/java/multithreading.html" class="prev">
        MultiThreading
      </a></span> <span class="next"><a href="/java/reflection.html">
        Reflection
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ea6663fd.js" defer></script><script src="/assets/js/2.2ade0f41.js" defer></script><script src="/assets/js/7.a1840e06.js" defer></script>
  </body>
</html>
