<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MultiThreading | Situ Book</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo-book.svg">
    <link rel="stylesheet" href="/katex.min.css">
    <meta name="description" content="Taking notes">
    
    <link rel="preload" href="/assets/css/0.styles.d3913af2.css" as="style"><link rel="preload" href="/assets/js/app.9f4db733.js" as="script"><link rel="preload" href="/assets/js/2.2ade0f41.js" as="script"><link rel="preload" href="/assets/js/3.79c807c9.js" as="script"><link rel="prefetch" href="/assets/js/10.7c8d5432.js"><link rel="prefetch" href="/assets/js/11.c96e85e2.js"><link rel="prefetch" href="/assets/js/12.12aee58a.js"><link rel="prefetch" href="/assets/js/13.d103d85a.js"><link rel="prefetch" href="/assets/js/14.eb1a2ce8.js"><link rel="prefetch" href="/assets/js/15.0263eebb.js"><link rel="prefetch" href="/assets/js/16.113eb911.js"><link rel="prefetch" href="/assets/js/17.341fa188.js"><link rel="prefetch" href="/assets/js/18.718ecd75.js"><link rel="prefetch" href="/assets/js/19.b7d53c4f.js"><link rel="prefetch" href="/assets/js/20.fde004c3.js"><link rel="prefetch" href="/assets/js/21.33b3bfe1.js"><link rel="prefetch" href="/assets/js/22.4d33c7c3.js"><link rel="prefetch" href="/assets/js/23.a986f9f2.js"><link rel="prefetch" href="/assets/js/24.21e0b79b.js"><link rel="prefetch" href="/assets/js/25.1e9fe201.js"><link rel="prefetch" href="/assets/js/26.8d8c6aa3.js"><link rel="prefetch" href="/assets/js/27.888c5464.js"><link rel="prefetch" href="/assets/js/28.d5a6810e.js"><link rel="prefetch" href="/assets/js/29.8c75e549.js"><link rel="prefetch" href="/assets/js/30.35acffba.js"><link rel="prefetch" href="/assets/js/31.2f701be9.js"><link rel="prefetch" href="/assets/js/32.ec3e1c28.js"><link rel="prefetch" href="/assets/js/33.a0ba6418.js"><link rel="prefetch" href="/assets/js/34.d71a2d26.js"><link rel="prefetch" href="/assets/js/35.aa1a3bb0.js"><link rel="prefetch" href="/assets/js/36.5beec393.js"><link rel="prefetch" href="/assets/js/37.bddd9be8.js"><link rel="prefetch" href="/assets/js/38.22cc3240.js"><link rel="prefetch" href="/assets/js/39.f0e6b679.js"><link rel="prefetch" href="/assets/js/4.e8ec5ebb.js"><link rel="prefetch" href="/assets/js/40.751da667.js"><link rel="prefetch" href="/assets/js/41.e8177c84.js"><link rel="prefetch" href="/assets/js/42.6599db0b.js"><link rel="prefetch" href="/assets/js/43.e61825ba.js"><link rel="prefetch" href="/assets/js/44.7f8c150c.js"><link rel="prefetch" href="/assets/js/45.1a75fea9.js"><link rel="prefetch" href="/assets/js/46.cf690e94.js"><link rel="prefetch" href="/assets/js/47.b5b9a971.js"><link rel="prefetch" href="/assets/js/48.7d959cd8.js"><link rel="prefetch" href="/assets/js/49.2c603054.js"><link rel="prefetch" href="/assets/js/5.69667846.js"><link rel="prefetch" href="/assets/js/50.7359011f.js"><link rel="prefetch" href="/assets/js/51.d011f67b.js"><link rel="prefetch" href="/assets/js/52.822ecd0a.js"><link rel="prefetch" href="/assets/js/53.848ea288.js"><link rel="prefetch" href="/assets/js/54.fc7eead7.js"><link rel="prefetch" href="/assets/js/55.920b844e.js"><link rel="prefetch" href="/assets/js/56.0a4f94f6.js"><link rel="prefetch" href="/assets/js/57.d842041f.js"><link rel="prefetch" href="/assets/js/58.c948d24b.js"><link rel="prefetch" href="/assets/js/6.27689200.js"><link rel="prefetch" href="/assets/js/7.3ca04897.js"><link rel="prefetch" href="/assets/js/8.1e40a8d0.js"><link rel="prefetch" href="/assets/js/9.23617160.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d3913af2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Situ Book</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://blog.situ2001.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/situ2001" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://blog.situ2001.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/situ2001" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tools</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/basis.html" class="sidebar-link">Basis</a></li><li><a href="/java/problems.html" class="sidebar-link">Problems</a></li><li><a href="/java/feature_jdk.html" class="sidebar-link">Feature</a></li><li><a href="/java/multithreading.html" aria-current="page" class="active sidebar-link">MultiThreading</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/multithreading.html#新建thread与task" class="sidebar-link">新建Thread与Task</a></li><li class="sidebar-sub-header"><a href="/java/multithreading.html#线程池" class="sidebar-link">线程池</a></li><li class="sidebar-sub-header"><a href="/java/multithreading.html#线程同步" class="sidebar-link">线程同步</a></li><li class="sidebar-sub-header"><a href="/java/multithreading.html#线程协助" class="sidebar-link">线程协助</a></li><li class="sidebar-sub-header"><a href="/java/multithreading.html#blocking-queue" class="sidebar-link">Blocking Queue</a></li><li class="sidebar-sub-header"><a href="/java/multithreading.html#semaphores" class="sidebar-link">Semaphores</a></li><li class="sidebar-sub-header"><a href="/java/multithreading.html#死锁" class="sidebar-link">死锁</a></li><li class="sidebar-sub-header"><a href="/java/multithreading.html#线程的状态" class="sidebar-link">线程的状态</a></li></ul></li><li><a href="/java/design_patterns.html" class="sidebar-link">Design patterns</a></li><li><a href="/java/reflection.html" class="sidebar-link">Reflection</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>C/C++</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构与算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node.js</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>课程</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="multithreading"><a href="#multithreading" class="header-anchor">#</a> MultiThreading</h1> <p>这是用来记录Java多线程编程相关内容的</p> <p>线程是什么呢？我觉得可以这样来表述吧：一个Program变成Process之后，系统分配了一定的资源。在一个process里头，可以有一或多个Thread即线程在里头跑。</p> <p>那么实际运行的时候，多条线程之间，是怎么跑起来的呢？如图
<img src="/assets/img/thread1.88ceae4f.jpg" alt="线程的概念"></p> <p>线程这些东西一般都要在操作系统课程里面再深入学习了吧，那下面就开始记录java里面的多线程编程的基础概念了</p> <h2 id="新建thread与task"><a href="#新建thread与task" class="header-anchor">#</a> 新建Thread与Task</h2> <p>Java中有一个interface叫做Runnable，顾名思义就是用来表示Thread要执行的任务。而传入一个Runnable进入Thread，Thread在<code>start()</code>或者<code>run()</code>的时候就会invoke这个Runnable里面对应的<code>run()</code>方法啦。</p> <p>我们可以新建一个Runnable然后在其里头Override掉run()这个方法，也可以创建一个实现这个接口的类，更有甚者，还可以直接extend于Thread类（不推荐这个做法）</p> <p>Thread类里头有一些方法要有个印象，也要对这个类里面一些Deprecated的方法进行规避，并了解原因。</p> <p><img src="/assets/img/thread2.2fe65092.jpg" alt="Thread"></p> <p>//TODO:为什么有一些方法如<code>stop()</code>被Deprecate了呢？</p> <p>对了，对于多线程编程，我觉得画图是一个挺好的方法，直接画几条线表示线程，有下面一些图还是挺实用的</p> <p><img src="/assets/img/thread3.3e968f0e.jpg" alt="join()"></p> <p>然后我用的教程的32.5小节就以jfx来示范了在特定线程下所执行的特定方法。（这跟安卓开发的UI thread有着异曲同工）（这个就不摘抄了，直接看书就行）</p> <h2 id="线程池"><a href="#线程池" class="header-anchor">#</a> 线程池</h2> <p>线程池的英语是<code>Thread pool</code>，顾名思义就是有一堆线程在里头的一个池子，我们可以用它来分配线程给不同的Task。
<img src="/assets/img/thread4.6abe6f74.jpg" alt="Thread pool1"> <img src="/assets/img/thread5.8c3756b7.jpg" alt="Thread pool2"></p> <h2 id="线程同步"><a href="#线程同步" class="header-anchor">#</a> 线程同步</h2> <p>多个线程同时操作一个数据，很容易使得这个数据corrupted（数据腐败？）
这个是使用了一个经典例子：银行存款或者是生产者消费者关系来举例。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">chapter32</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountWithoutSync</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Account</span> account <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Create and launch 100 threads</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AddAPennyTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        executor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Wait until all tasks are finished</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>executor<span class="token punctuation">.</span><span class="token function">isTerminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;What is balance? &quot;</span> <span class="token operator">+</span> account<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// A thread for adding a penny to the account</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AddAPennyTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            account<span class="token punctuation">.</span><span class="token function">deposit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// An inner class for account</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Account</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> balance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> balance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deposit</span><span class="token punctuation">(</span><span class="token keyword">int</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> newBalance <span class="token operator">=</span> balance <span class="token operator">+</span> amount<span class="token punctuation">;</span>
            <span class="token comment">//balance += amount;</span>

            <span class="token comment">// This delay is deliberately added to magnify the</span>
            <span class="token comment">// data-corruption problem and make it easy to see.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>

            balance <span class="token operator">=</span> newBalance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其实上面的这段代码可能有如下的运行情况
<img src="/assets/img/thread6.bcc6c839.jpg" alt="non-synchronized"></p> <p>这种情况呢就是所谓的线程不安全啦，这个安全不安全的词语经常有见到，所以还是要了解一下的。(摘抄自原文)
<code>Obviously, the problem is that Task 1 and Task 2 are accessing a common resource in a way that causes a conflict. This is a common problem, known as a race condition, in multithreaded programs. A class is said to be thread-safe if an object of the class does not cause a race condition in the presence of multiple threads. As demonstrated in the preced- ing example, the Account class is not thread-safe.</code></p> <p>所以为了解决同时跑同一个代码块的情况，我们可以给他加上一个关键字<code>synchronized</code>来使一块代码或类线程同步。如下</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">deposit</span><span class="token punctuation">(</span><span class="token keyword">int</span> amount<span class="token punctuation">)</span>
</code></pre></div><p>代码运行起来就会像这样子了，实际原理是给对象配了把锁。只有拿到锁的线程才能对这个对象的对象方法进行访问（这句话可以理解为每个对象都有自己的唯一的一把锁，而这个锁可以apply在实例方法或者static方法上的）
<img src="/assets/img/thread7.4510232a.jpg" alt="synchronized">
结合上下文就可以知道，一个线程要想进入这块代码区域，就要拿下面代码的<code>expr</code>的锁，这锁没被其他线程拿走就自己拿了开始执行，执行完之后再释放。反之，就要等拿了锁的线程释放这把锁。</p> <p>使用是像下面这样子</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>expr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    statements<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的expr其实就是对象引用，<code>account</code>在这里就是指的class Account（实例锁）（也可以填入Account.class（类锁）或者this（this用的时候你要确定这个this指的是谁）)，也就是说account对象运行到这里的时候，都要拿锁，如果锁被其他同类拿了，就要等同类把lock给release掉</p> <p>但是，<code>synchronized</code>只是方便了我们的使用，其实这个线程同步的实质就是加了lock嘛，java里头也有Lock这个类，我们可以直接使用它。（前面的<code>synchronized</code>利用的是类或者一个对象上的锁，而这个类是直接新创建了一个Lock对象，这个对象实际就是一把锁）
<img src="/assets/img/thread8.c27838c4.jpg" alt="Lock"></p> <p>怎么用呢，先实例化一个static的Lock，然后在想要线程同步的代码块前后使用即可</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Create a lock</span>

lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Acquire the lock</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> newBalance <span class="token operator">=</span> balance <span class="token operator">+</span> amount<span class="token punctuation">;</span>

    <span class="token comment">// This delay is deliberately added to magnify the</span>
    <span class="token comment">// data-corruption problem and make it easy to see.</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    balance <span class="token operator">=</span> newBalance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span class="token keyword">finally</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Release the lock</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="线程协助"><a href="#线程协助" class="header-anchor">#</a> 线程协助</h2> <p>这里不讲位置了，主要是笔记，自己看的懂就行了。await()是让这条线程放掉锁，然后idle在那个代码处，等待其他地方传来的<code>signal</code>即是其他线程调用了<code>signal() signalAll()</code> <img src="/assets/img/thread9.398a89e1.jpg" alt="Interface"></p> <p>英语就是Thread cooperate了吧，也可以叫做Thread coordinate</p> <p>就是从Lock对象里调用方法<code>newCondition()</code>来获得一个对应Lock对象的Condition</p> <p>下面是一个取款存款的操作，取款的话当然是不能透支啊，所以我们可以在取款和存款的两条线程里头，加入一个<code>newDeposit</code>条件来进行线程之间的沟通合作。
<img src="/assets/img/thread10.d09fd990.jpg" alt="Coordinate"></p> <p>详细的实现代码，请翻书到32.9小节那里。</p> <h2 id="blocking-queue"><a href="#blocking-queue" class="header-anchor">#</a> Blocking Queue</h2> <p>其实从刚刚的Condition那里，如果我们要判断一个队列是否满或空来控制存入取出的线程，就可以使用Condition来控制了。但，jvav官方就给了一些现成的东西。
<img src="/assets/img/thread11.fc9cafea.jpg" alt="Blocking Queue"></p> <p>其实是从Collection Framework那边延伸出来的，只不过多了一些自己特有的method罢了。
<img src="/assets/img/thread12.e800f4f3.jpg" alt="Inheritance"></p> <p>(...说白了就是一个容量有限的队列而已...)</p> <h2 id="semaphores"><a href="#semaphores" class="header-anchor">#</a> Semaphores</h2> <p>这翻译过来叫做信号塔...?算了还是用英语顶住吧。这个跟Lock是几乎一致的，但是它可以允许多个线程拿到锁进入（1~n个）。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Semaphore</span> semaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deposit</span><span class="token punctuation">(</span><span class="token keyword">int</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//codes</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="死锁"><a href="#死锁" class="header-anchor">#</a> 死锁</h2> <p>emm这个可以像学校的计算机导论说的进程要文件资源那样理解，（换个无非就是线程想要锁嘛</p> <h2 id="线程的状态"><a href="#线程的状态" class="header-anchor">#</a> 线程的状态</h2> <p>线程的状态大概可以分为五种吧：<strong>New Ready Running Blocked Finished</strong></p> <p>先是一张图
<img src="/assets/img/thread13.01d4a149.jpg" alt="Thread status"></p> <p>然后是解释</p> <blockquote><p>Tasks are executed in threads. Threads can be in one of the five states: New, Ready, Running, Blocked, or Finished (see Figure 32.25).</p> <p>When a thread is newly created, it enters the New state. After a thread is started by calling its start() method, it enters the Ready state. A ready thread is runnable but may not be running yet. The operating system has to allocate CPU time to it.</p> <p>When a ready thread begins executing, it enters the Running state. A running thread can enter the Ready state if its given CPU time expires or its yield() method is called.</p> <p>A thread can enter the Blocked state (i.e., become inactive) for several reasons. It may have invoked the join(), sleep(), or wait() method. It may be waiting for an I/O operation to finish. A blocked thread may be reactivated when the action inactivating it is reversed. For example, if a thread has been put to sleep and the sleep time has expired, the thread is reactivated and enters the Ready state.
Finally, a thread is Finished if it completes the execution of its run() method.</p> <p>The isAlive() method is used to find out the state of a thread. It returns true if a thread is in the Ready, Blocked, or Running state; it returns false if a thread is new and has not started or if it is finished.</p> <p>The interrupt() method interrupts a thread in the following way: If a thread is currently in the Ready or Running state, its interrupted flag is set; if a thread is currently blocked, it is awakened and enters the Ready state, and a java.lang.InterruptedException is
thrown.</p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/java/feature_jdk.html" class="prev">
        Feature
      </a></span> <span class="next"><a href="/java/design_patterns.html">
        Design patterns
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9f4db733.js" defer></script><script src="/assets/js/2.2ade0f41.js" defer></script><script src="/assets/js/3.79c807c9.js" defer></script>
  </body>
</html>
